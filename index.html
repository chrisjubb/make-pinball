<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - collada</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;

			}

			a { color: skyblue }
		</style>
	</head>
	<body>
		<div id="info">
			pinball
		</div>

		<script src="lib/three.min.js"></script>

		<script src="lib/ammo.js"></script>

		<script src="lib/underscore-min.js"></script>

		<script src="js/loaders/collada/Animation.js"></script>
		<script src="js/loaders/collada/AnimationHandler.js"></script>
		<script src="js/loaders/collada/KeyFrameAnimation.js"></script>

		<script src="js/loaders/ColladaLoader.js"></script>

		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>

		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;

			var camera, scene, renderer, objects;
			var dae;

			// physics
			var dynamicsWorld;
            var bulletMaterial;
            var physicsMeshCallbacks = [];

			function start() {
				var loader = new THREE.ColladaLoader();
				loader.options.convertUpAxis = true;
				loader.load( 'wire_forms.dae', function ( collada ) {

					initPhysics();

					dae = collada.scene;

					dae.traverse( function ( child ) {
						// console.log(child.name + " - " + dpos(child.position));

						if(child.name[0] == 'P' && child.name[1] == '_') {
							//console.log(child.name);
							child.visible = false;
							addTriangleMesh(child);
						}

						if(child.name == "BALL") {
							console.log("[!] Adding ball - " + dpos(child.position));
							addBall(child);
						}

						if(child.name == "Plane") {
							console.log("[!] Adding plane");
							// child.visible = false;
							addPlane(child);
						}

						if(child.name == "FLIPPER") {
							console.log("[!] Adding flipper");
							addFlipper(child);
						}

						if ( child instanceof THREE.SkinnedMesh ) {

							var animation = new THREE.Animation( child, child.geometry.animation );
							animation.play();

						}

					} );

					dae.scale.x = dae.scale.y = dae.scale.z = 0.002;
					dae.updateMatrix();

					initScene();
					animate();

				} );
			}

			function dpos(pos) {
			if(pos) {
					return "[ " + pos.x + ", " + pos.y + ", " + pos.z + " ]";
				}
				else {
					return '[not valid]';
				}
			}

			function initPhysics() {
				var collisionConfiguration = new Ammo.btDefaultCollisionConfiguration();
                var dispatcher = new Ammo.btCollisionDispatcher(collisionConfiguration);
                var overlappingPairCache = new Ammo.btDbvtBroadphase();
                var solver = new Ammo.btSequentialImpulseConstraintSolver();
                dynamicsWorld = new Ammo.btDiscreteDynamicsWorld(dispatcher, overlappingPairCache, solver, collisionConfiguration);
                dynamicsWorld.setGravity(new Ammo.btVector3(0, -3.8203, 21.6658));
			}

			function addTriangleMesh(original) {

				var physicsMesh = new Ammo.btTriangleMesh();

				original.updateMatrixWorld();

				var mesh = original.children[0];
				var geometry = mesh.geometry;
				_.each(geometry.faces, function(face) {

					var localV0 = geometry.vertices[face.a];
					var localV1 = geometry.vertices[face.b];
					var localV2 = geometry.vertices[face.c];

					var worldV0 = original.localToWorld(localV0.clone());
					var worldV1 = original.localToWorld(localV1.clone());
					var worldV2 = original.localToWorld(localV2.clone());

					physicsMesh.addTriangle(
									new Ammo.btVector3(worldV0.x, worldV0.y, worldV0.z),
									new Ammo.btVector3(worldV1.x, worldV1.y, worldV1.z),
									new Ammo.btVector3(worldV2.x, worldV2.y, worldV2.z)
									);
				});

				var shape = new Ammo.btBvhTriangleMeshShape(physicsMesh, true, true);

				var transform = new Ammo.btTransform();
                transform.setIdentity();
                transform.setOrigin(new Ammo.btVector3(0, 0, 0));

                var mass = 0;
                var localInertia = new Ammo.btVector3(0, 0, 0);
                shape.calculateLocalInertia(mass, localInertia);

                var motionState = new Ammo.btDefaultMotionState(transform);
                var rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, shape, localInertia);
                var body = new Ammo.btRigidBody(rigidBodyInfo);
                dynamicsWorld.addRigidBody(body);
                body.activate();
			}

			function addBall(original) {
				var pos = original.position.clone();
                var rot = new THREE.Quaternion();
                rot.setFromEuler(original.rotation);

                var shape = new Ammo.btSphereShape(0.135);
                var transform = new Ammo.btTransform();
                transform.setIdentity();
                transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));

                var mass = 1;
                var localInertia = new Ammo.btVector3(0, 0, 0);
                shape.calculateLocalInertia(mass, localInertia);

                var motionState = new Ammo.btDefaultMotionState(transform);
                var rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, shape, localInertia);
                var body = new Ammo.btRigidBody(rigidBodyInfo);
                dynamicsWorld.addRigidBody(body);
                body.activate();

                pos.negate();

                addPhysicsCallback(original, body, transform);

                return body;
			}

			function addPlane(original) {
				var pos = original.position.clone();

				var shape = new Ammo.btStaticPlaneShape(new Ammo.btVector3(0, 1, 0), 0);

				var transform = new Ammo.btTransform();
                transform.setIdentity();
                transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));

                var mass = 0;
                var localInertia = new Ammo.btVector3(0, 0, 0);
                shape.calculateLocalInertia(mass, localInertia);

                var motionState = new Ammo.btDefaultMotionState(transform);
                var rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, shape, localInertia);
                var body = new Ammo.btRigidBody(rigidBodyInfo);
                dynamicsWorld.addRigidBody(body);
                body.activate();
			}

			function addToConvexHull(shape, threePosition) {
				shape.addPoint(new Ammo.btVector3(threePosition.x, threePosition.y, threePosition.z));
			}

			function addFlipper(original) {
				var shape = new Ammo.btConvexHullShape();

				var child = original.children[0]; // should be the first one
				var mesh = child;
				var geometry = mesh.geometry;
				_.each(geometry.vertices, function(vertex) {
					addToConvexHull(shape, vertex);
					//console.log(vertex);
				});

				original.children[0].visible = false;

				var pos = original.position.clone();
				var transform = new Ammo.btTransform();
                transform.setIdentity();
                transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));

                var mass = 0;
                var localInertia = new Ammo.btVector3(0, 0, 0);
                shape.calculateLocalInertia(mass, localInertia);

                var motionState = new Ammo.btDefaultMotionState(transform);
                var rigidBodyInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, shape, localInertia);
                var body = new Ammo.btRigidBody(rigidBodyInfo);
                dynamicsWorld.addRigidBody(body);
                body.activate();
			}

			function addPhysicsCallback(object, body, transform) {
				physicsMeshCallbacks.push(function() {
                    body.getMotionState().getWorldTransform(transform);

                    var origin = transform.getOrigin();
                    object.position.set(origin.x(), origin.y(), origin.z());

                    var rotation = transform.getRotation();
                    object.quaternion.set(rotation.x(), rotation.y(), rotation.z(), rotation.w());
                });
			}

			function initScene() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.001, 1.0 );
				camera.position.x = 0.01;
				camera.position.y = 0.012;
				camera.position.z = 0.01;
				camera.lookAt( new THREE.Vector3(camera.position.x, 0, 0.002) );

				// Add the COLLADA

				scene.add( dae );

				// Lights

				scene.add( new THREE.AmbientLight( 0x050505 ) );

				var directionalLight = new THREE.DirectionalLight(0x050505 );
				directionalLight.position.x = Math.random() - 0.5;
				directionalLight.position.y = Math.random() - 0.5;
				directionalLight.position.z = Math.random() - 0.5;
				directionalLight.position.normalize();
				scene.add( directionalLight );

				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				//

				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			//

			function animate() {

				requestAnimationFrame( animate );

				render();
				stats.update();

			}

			var clock = new THREE.Clock();

			function render() {

				var delta = clock.getDelta();

				THREE.AnimationHandler.update( clock.getDelta() );

				dynamicsWorld.stepSimulation(1.0 / 150.0, 2);
				_.each(physicsMeshCallbacks, function(callback) {
					callback();
				});

				renderer.render( scene, camera );

			}

			start();

		</script>
	</body>
</html>
