<!DOCTYPE html>
<html lang="en">
	<head>
		<title>makepinball.com</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				color: white;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;
			}

			#instructions {
				color: white;
				position: absolute;
				bottom: 20px;
				width: 50%;
				z-index: 100;
			}

			a { color: skyblue }

			#configContainer {
				position: absolute;
				right: 0;
				top: 0;
				height: 100%;
				width: 20%;
				background-color: white;
			}

			#configButtons {
			}

			#configScrollContainer {
				height: 90%;
			}

			#config {
				overflow: scroll;
				width: 100%;
				height: 100%;
			}

			#canvasContainer {
				position: absolute;
				left: 0;
				top: 0;
				width: 80%;
				height: 100%;
				background-color: blue;
			}
		</style>
	</head>
	<body>
		<div id="info">
			makepinball.com <a href="https://github.com/chrisjubb/">github</a>
		</div>
		<div id="instructions">
			<p>This is a work in progress.</p>
			<p>Feel free to contribute on <a href="https://github.com/chrisjubb/makepinball.com/">github</a></p>

			<p>Left Flipper = 'A'</p>
			<p>Right Flipper = 'L'</p>
			<p>Plunger = 'F'</p>
			<p>Reset balls = 'R'</p>

			<p>You can change physics parameters on the right and click 'UPDATE' to see the changes.</p>
			<p>Uses <a href="http://threejs.org/">three.js</a>, <a href="https://github.com/kripken/ammo.js/">ammo.js</a> and <a href="http://www.blender.org/">Blender</a>.
		</div>
		<div id="canvasContainer"></div>
		<div id="configContainer">
			<div id="configButtons">
				<div><button onclick="configHide();">Hide</button></div>
				<div><button onclick="configOutputJson();">output json</button></div>
				<div><button onclick="configUpdate();">UPDATE</button></div>
			</div>
			<div id="configScrollContainer">
				<div id="config"></div>
			</div>
		</div>

		<script src="lib/three.js"></script>
		<script src="lib/ammo.js"></script>
		<script src="lib/underscore-min.js"></script>
		<script src="lib/jquery.js"></script>
		<script src="lib/backbone.js"></script>
		<script src="lib/class.js"></script>

		<script src="config/config.js"></script>

		<!-- three js -->
		<script src="js/loaders/collada/Animation.js"></script>
		<script src="js/loaders/collada/AnimationHandler.js"></script>
		<script src="js/loaders/collada/KeyFrameAnimation.js"></script>

		<script src="js/shaders/SSAOShader.js"></script>
		<script src="js/shaders/CopyShader.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script>
		<script src="js/postprocessing/EffectComposer.js"></script>

		<script src="js/loaders/ColladaLoader.js"></script>

		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>

		<script src="utils.js"></script>
		<script src="light.js"></script>
		<script src="game.js"></script>
		<script src="view.js"></script>

		<script id="light_vertex_shader" type="x-shader/x-vertex">
			varying vec2 vUv;
			varying vec3 vNormal;
			varying vec3 vViewPosition;

			void main() {
				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

				vUv = uv;
				vNormal = normalize( normalMatrix * normal );
				vViewPosition = -mvPosition.xyz;

				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}
		</script>

		<script id="light_fragment_shader" type="x-shader/x-fragment">
			uniform sampler2D backgroundTexture;
			uniform sampler2D overlayTexture;

			uniform vec4 backgroundTint;

			varying vec2 vUv;
			varying vec3 vNormal;
			varying vec3 vViewPosition;

			void main() {
				vec4 backgroundColor = texture2D( backgroundTexture, vUv );
				vec4 overlayColor = texture2D( overlayTexture, vUv );

				// hack in a fake pointlight at camera location, plus ambient
				vec3 normal = normalize( vNormal );
				vec3 lightDir = normalize( vViewPosition );

				float dotProduct = max( dot( normal, lightDir ), 0.0 ) + 0.2;
				gl_FragColor.rgb = ((backgroundColor.rgb * backgroundTint.rgb * (1.0 - overlayColor.a)) +
									(overlayColor.rgb * (overlayColor.a))) * dotProduct;
				gl_FragColor.a = (backgroundColor.a * backgroundTint.a) + overlayColor.a;
			}
		</script>

		<script>

			if(!Detector.webgl) Detector.addGetWebGLMessage();

			var game = new Pin.Game();
			var view = new Pin.View();

			view.setLightShader("light_vertex_shader", "light_fragment_shader");
			view.setFlipperData(game.getFlipperData());
			view.setInputMapping(game.getInputMapping());

            // BLENDER -> THREE
            // XYZ     -> +X +Z -Y

            function getCanvasContainer() {
				return $("#canvasContainer");
			}

            // physics config
			var physCfg = new Config().load("physics.config.json", "physics.settings.json");
			var physCfgView = new ConfigView({ model: physCfg });
            $("#config").html(physCfgView.render().el);

            // config related
			function configHide() {
				$("#configContainer").css("width", "0%");
				getCanvasContainer().css("width", "100%");
				onWindowResize();
			}

			function configOutputJson() {
				console.log(JSON.stringify(physCfg.getSettings()));
			}

			function configUpdate() {
				physCfgView.updateValues();
				view.initPhysics();
			}

			function onWindowResize() {
				view.onResize();
			}

			window.addEventListener('resize', onWindowResize, false);

			function animate() {
				requestAnimationFrame(animate);

				view.preUpdate();
				var switchState = view.getSwitchState();
				game.update(switchState);
				var lightState = game.getLightState();
				var forceState = game.getForceState();
				var forceFromSwitchState = game.getForceFromSwitchState()
				view.update(lightState, forceState, forceFromSwitchState);
				view.render();
				stats.update();
			}

			physCfg.ready(function() {
				view.setPhysicsConfig(physCfg);
				view.load(getCanvasContainer());
			});

			view.ready(function() {
				animate();
			});

			var stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			getCanvasContainer().append(stats.domElement);

		</script>
	</body>
</html>
